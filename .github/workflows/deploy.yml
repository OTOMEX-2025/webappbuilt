name: Deploy to MindPal Server

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  deploy:
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.action == 'closed' && github.event.pull_request.merged == true)
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸšš Checkout code
      uses: actions/checkout@v4

    - name: ðŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: ðŸ“¦ Install dependencies
      run: npm ci

    - name: ðŸ—ï¸ Build application
      run: npm run build

    - name: ðŸ”¨ Create nginx configuration
      run: |
        cat > nginx.conf << 'EOF'
        server {
            listen 80;
            server_name mindpal.otomexx.co.za;
            
            # Cloudflare real IP
            set_real_ip_from 103.21.244.0/22;
            set_real_ip_from 103.22.200.0/22;
            set_real_ip_from 103.31.4.0/22;
            set_real_ip_from 104.16.0.0/13;
            set_real_ip_from 104.24.0.0/14;
            set_real_ip_from 108.162.192.0/18;
            set_real_ip_from 131.0.72.0/22;
            set_real_ip_from 141.101.64.0/18;
            set_real_ip_from 162.158.0.0/15;
            set_real_ip_from 172.64.0.0/13;
            set_real_ip_from 173.245.48.0/20;
            set_real_ip_from 188.114.96.0/20;
            set_real_ip_from 190.93.240.0/20;
            set_real_ip_from 197.234.240.0/22;
            set_real_ip_from 198.41.128.0/17;
            real_ip_header CF-Connecting-IP;
            
            location / {
                proxy_pass http://localhost:7015;
                proxy_http_version 1.1;
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection 'upgrade';
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
                proxy_set_header CF-Connecting-IP $http_cf_connecting_ip;
                proxy_set_header CF-IPCountry $http_cf_ipcountry;
                proxy_cache_bypass $http_upgrade;
            }
        }
        EOF

    - name: ðŸ“ Create PM2 ecosystem file
      run: |
        cat > ecosystem.config.js << 'EOF'
        module.exports = {
          apps: [{
            name: 'mindpal',
            script: 'node_modules/next/dist/bin/next',
            args: 'start',
            instances: 1,
            exec_mode: 'fork',
            env: {
              PORT: 7015,
              NODE_ENV: 'production'
            }
          }]
        }
        EOF

    - name: ðŸ“¦ Create deployment package
      run: |
        zip -r deployment-package.zip . -x "*.git*" "*.github*" "node_modules/*"

    - name: ðŸš€ Deploy to server
      uses: appleboy/scp-action@v0.1.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USERNAME }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        source: "deployment-package.zip"
        target: "/var/www/mindpal.otomexx.co.za/"

    - name: ðŸ”§ Run deployment script on server
      uses: appleboy/ssh-action@v0.1.10
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USERNAME }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        script: |
          /home/ubuntu/scripts/deploy-app.sh "mindpal" "mindpal.otomexx.co.za" "7015" "/var/www/mindpal.otomexx.co.za/deployment-package.zip"